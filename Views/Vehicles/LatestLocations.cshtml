<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Latest Vehicle Locations</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <style>
        #map {
            height: 500px;
            width: 100%;
        }
    </style>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.3/css/dataTables.jqueryui.min.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/rowgroup/1.3.0/css/rowGroup.jqueryui.min.css" />
</head>
<body>
    <div class="container">
        <h2 class="mt-5">Latest Vehicle Locations</h2>
        <table id="dataTable" class="table table-bordered mt-3">
            <thead class="thead-light">
                <tr>
                    <th>Vehicle ID</th>
                    <th>Latitude</th>
                    <th>Longitude</th>
                    <th>Timestamp</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var location in Model)
                {
                    <tr>
                        <td>@location.VehicleId</td>
                        <td>@location.Latitude</td>
                        <td>@location.Longitude</td>
                        <td>@location.Timestamp.ToString("yyyy-MM-dd HH:mm:ss")</td>
                    </tr>
                }
            </tbody>
        </table>

        <div id="map"></div>
    </div>

    <!-- Load jQuery first -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <!-- DataTables scripts -->
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.13.3/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.13.3/js/dataTables.jqueryui.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/rowgroup/1.3.0/js/dataTables.rowGroup.min.js"></script>

    <script>
        let map;
        let markers = []; // Array to store marker references

        const dataTable = $('#dataTable').DataTable({
            "order": [],
        });

        function initMap() {
            const defaultCenter = { lat: 37.7749, lng: -122.4194 };
            map = new google.maps.Map(document.getElementById("map"), {
                center: defaultCenter,
                zoom: 4,
                mapId: "fe0ba81938d4e300"
            });

            const locations = @Html.Raw(Json.Serialize(Model));
            updateMapMarkers(locations);
        }

        function updateMapMarkers(locations) {
            // Clear existing markers
            markers.forEach(marker => marker.setMap(null));
            markers = [];

            // Add markers based on filtered data
            locations.forEach(location => {
                const position = { lat: location.latitude, lng: location.longitude };

                const markerContent = document.createElement("div");
                markerContent.innerHTML = `<span style="font-size: 20px; color: red;">📍 ${location.vehicleId}</span>`;

                const marker = new google.maps.marker.AdvancedMarkerElement({
                    position: position,
                    map: map,
                    content: markerContent
                });

                const infoWindow = new google.maps.InfoWindow({
                    content: `<strong>Vehicle ID:</strong> ${location.vehicleId}<br>
                                      <strong>Latitude:</strong> ${location.latitude}<br>
                                      <strong>Longitude:</strong> ${location.longitude}<br>
                                      <strong>Timestamp:</strong> ${location.timestamp}`
                });

                marker.addListener("click", () => {
                    infoWindow.open(map, marker);
                });

                markers.push(marker);
            });
        }

        // Event listener for DataTable redraw (filtering)
        dataTable.on('draw', function () {
            const filteredData = dataTable.rows({ filter: 'applied' }).data().toArray();
            const filteredLocations = filteredData.map(row => ({
                vehicleId: row[0],
                latitude: parseFloat(row[1]),
                longitude: parseFloat(row[2]),
                timestamp: row[3]
            }));
            updateMapMarkers(filteredLocations);
        });

    </script>

    <!-- Google Maps API with AdvancedMarkerElement library -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDJElz2O69f4GMdoaVzIE6PP64wCLdopVk&callback=initMap&libraries=marker" async defer></script>

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
</body>
</html>
